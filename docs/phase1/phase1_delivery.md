# 第 1 阶段交付：需求细化与信息架构

> 覆盖周期：第 1 阶段（2 周）
>
> 目标：统一 MVP 范围、完成核心流程设计、沉淀数据模型与项目骨架，为第 2 阶段功能实现奠定规范基础。

---

## 1. 需求基线与用户画像

### 1.1 核心角色
- **主力考生（备考生）**：主力使用者，关注高频题目复习、总结沉淀与提醒节奏，需平板横屏高效操作。
- **兼职教师/教研助理**：负责整理题库与标签文件，要求导入流程顺畅、数据字段统一。
- **技术维护者（内部）**：配置表格模板、诊断导入问题、维护数据一致性。

### 1.2 目标拆解（MVP）
| 模块 | 用户目标 | 系统响应 | 备注 |
| --- | --- | --- | --- |
| 题目推送 | 按日程定时推送指定数量题目，回顾未完成题 | 加载题干+选项，展示历史总结提示 | 支持线下使用，优先加载本地缓存 |
| 草稿记录 | 输入关键词/推理思路/易错点，保存草稿 | 草稿写入草稿表，记录时间与版本 | 自动保存草稿版本，提示保存成功 |
| 总结归档 | 提交结构化总结并绑定标签 | 写入总结表；更新题目完成次数 | 选择学科/知识点、添加标签前校验必填 |
| 标签管理 | 快速勾选或检索标签 | 展示标签树 & 常用标签卡片 | 允许通过编号/搜索添加；保持层级信息 |
| 日程规划 | 规划提醒时间与题目数量 | 生成日程项并触发定时推送 | 记录科目、数量、是否已完成 |

### 1.3 用户故事（节选）
1. 作为备考生，我希望在平板上收到符合计划的题目推送，以便按节奏复习。
2. 作为备考生，我希望草稿区能自动保存并回显历史版本，避免误操作丢失内容。
3. 作为备考生，我希望总结界面能自动加载上一轮总结和标签提示，加速复盘。
4. 作为教研助理，我希望通过模板导入题目时能得到字段校验提示，以便快速定位问题。
5. 作为维护者，我希望能导出当前题库、草稿、总结的 CSV 备份，保证数据安全。

### 1.4 非功能需求
- **性能**：题目加载 <2 秒、日程操作响应 <200ms、列表滚动无明显卡顿。
- **可用性**：草稿自动保存、离线缓存最近两次推送的题目、支持蓝牙键盘快捷键。
- **安全**：本地数据库加密、导出文件需本地确认密码、日志记录导入/导出操作。
- **可扩展性**：模块化结构，后续可拓展云同步、AI 分析等能力。

---

## 2. 关键流程与交互时序

### 2.1 题库导入流程
1. 教研助理打开“标签 & 题库管理”页 → 选择“导入资源表”。
2. 系统校验文件格式（xlsx/csv）、表头一致性，提示错误列信息。
3. 解析器拆分题干、选项、答案、解析、初始标签等字段，写入 **resource_items**。
4. 同步生成题目与标签初始关联（如有），并记录导入日志。

### 2.2 推题 & 草稿-总结流程
1. 日程触发 → 系统查询计划 → 拉取题目队列（优先未完成/需复习题）。
2. 刷题页加载题目卡片（左侧），右侧出现草稿区（关键词/推理思路/易错点）。
3. 用户填写草稿 → 点击“保存草稿”或超时自动保存（记录版本号与时间）。
4. 系统展示标准答案与历史总结卡片（若有），草稿区切换为“总结模式”。
5. 用户填写总结、选择学科/知识点并勾选标签 → 提交。
6. 系统写入总结表、更新题目完成次数、同步标签关系 → 返回下一题。

### 2.3 标签管理流程
1. 用户进入“标签”页，左侧展示标签树（文件夹 + 表格），右侧显示表格列表。
2. 点击标签节点 → 中部显示该标签下的题目/总结条目卡片，可批量操作。
3. 支持拖拽标签节点调整层级；操作后同步更新 **tag_nodes** 与 **tag_relations**。
4. 提供编号搜索，输入数字跳转到对应标签。

---

## 3. 信息架构与界面骨架

### 3.1 全局导航
```
底部导航栏
 ├─ 刷题（默认页）
 │   ├─ 推题卡片（题目列表 / 单题）
 │   └─ 草稿/总结分栏（右侧上下分区）
 ├─ 日程
 │   ├─ 日历视图（周/日切换）
 │   └─ 日程详情侧边栏（可编辑）
 └─ 标签
     ├─ 标签树（左）
     ├─ 标签内容（中）
     └─ 表格详情 / 导入导出操作（右）
```

### 3.2 刷题页低保真原型（横屏）
```
┌─────────────────────────────┬─────────────────────────────┐
│           题目材料           │        历史总结提示区域        │
│  [题干+选项卡片，可上下滑动] │  [最新总结、标签 Chips、错题提示] │
├─────────────────────────────┤─────────────────────────────┤
│           题目材料补充         │        草稿/总结编辑区        │
│  [解析、附图区域，可折叠]     │  [关键词 | 推理思路 | 易错点]   │
│                                 │  [保存草稿] [提交总结]按钮      │
└─────────────────────────────┴─────────────────────────────┘
底部固定栏：左-返回题单，中-计时器，右-下一题 / 完成
```

### 3.3 日程页骨架
- **左侧**：日历 + 时间轴，可拖拽调整计划块。
- **右侧浮层**：计划详情（科目、目标题数、重复规则），支持快速标记完成。
- **顶部**：筛选科目、显示今日剩余题数。

### 3.4 标签页骨架
- **左列**：树形标签结构，提供展开/折叠/搜索。
- **中列**：所选标签下的总结列表，可排序（时间/错题次数）。
- **右列**：表格详情（字段编辑）、导入/导出、批量操作按钮。

---

## 4. 数据模型与数据字典

### 4.1 实体关系概览
```
resource_items (1) ────< draft_notes (多)
      │                    │
      │                    └──< summary_notes (多)
      │                                │
      └──< schedule_entries (多)       └──< tag_relations (多)
                          │                     │
                          └──> schedule_logs (多)│
tag_nodes (1) ────────────────┘
```

### 4.2 表结构定义
| 表名 | 关键字段 | 描述 |
| --- | --- | --- |
| `resource_items` | `id`、`subject`、`question_text`、`options_json`、`answer`、`analysis`、`source_tag_path`、`completed_count`、`next_review_at` | 题库主表，记录题目原始内容与复习状态 |
| `draft_notes` | `id`、`question_id`、`keywords`、`reasoning`、`pitfalls`、`version`、`created_at` | 草稿记录，多版本存档 |
| `summary_notes` | `id`、`question_id`、`subject`、`knowledge_subset`、`keywords`、`reasoning`、`pitfalls`、`confidence_level`、`updated_at` | 正式总结，提供后续回显 |
| `tag_nodes` | `id`、`name`、`path`、`parent_id`、`shortcode`、`color`、`created_at` | 标签树节点，包含文件夹和标签两类 |
| `tag_relations` | `tag_id`、`summary_id`、`question_id`、`created_at`、`manual` | 标签关联表，记录关联来源（手动/导入） |
| `schedule_entries` | `id`、`subject`、`target_count`、`repeat_type`、`time_slots_json`、`next_trigger_at`、`timezone` | 日程计划表，记录触发条件 |
| `schedule_logs` | `id`、`schedule_id`、`triggered_at`、`delivered_count`、`status`、`notes` | 日程执行日志，追踪推送历史 |
| `import_jobs` | `id`、`file_name`、`status`、`error_report`、`created_at` | 导入记录，用于审计与问题追踪 |

### 4.3 字段规范
- 所有时间字段使用 ISO 8601 字符串存储，数据库层面采用 `INTEGER`（时间戳）+ `TEXT`（显示值）组合。
- `options_json` 采用 JSON 数组形式，兼容选择题/多选题/问答题。
- `knowledge_subset` 与 `tags` 字段采用逗号分隔短码，同时在 `tag_relations` 中建立细颗粒度映射。
- 引入 `confidence_level`（0-100）以支持后续 AI 建议与复习优先级计算。

---

## 5. 技术栈与项目框架设计

### 5.1 技术选型
- **客户端**：Kotlin + Jetpack Compose，多模块 Gradle（`app` + `feature-*` + `core-*`）。
- **持久化**：Room + SQLCipher（加密）；配合 Apache POI/SheetJS（Kotlin Multiplatform wrapper）处理 Excel/CSV 导入导出。
- **任务调度**：WorkManager（周期性任务） + AlarmManager（精确提醒）。
- **依赖注入**：Hilt；**日志**：Timber；**JSON**：kotlinx.serialization。
- **脚本扩展**：预留 `scripts/` 目录存放 Python 解析器，未来用于 AI 题库拆分。

### 5.2 模块划分（初版）
```
app/                      # 入口，组合导航 & 全局主题
├─ feature-quiz/          # 刷题 & 草稿总结流程
├─ feature-schedule/      # 日程规划
├─ feature-tag/           # 标签管理
├─ core-data/             # 数据仓库、Room 数据库、导入导出
├─ core-domain/           # 用例、实体、调度策略
├─ core-ui/               # 通用 Compose 组件、布局
└─ core-testing/          # 测试工具与假数据
```
- 采用 Clean Architecture：`feature-*` 依赖 `core-domain` + `core-data`，`core-data` 实现接口。
- 预留 `sync` 与 `ai` 模块空壳，保持依赖隔离，后续按需扩展。

### 5.3 数据访问层设计
- Repository 接口统一放置于 `core-domain`，实现位于 `core-data`。
- Room 实体命名与数据字典保持一致；导入流程通过 `ImportJobProcessor` 处理。
- 提供 `DraftAutosaveService`（WorkManager 定时保存）、`ReviewScheduler`（计算复习顺序）。

### 5.4 配置与开发基线
- 代码风格：Kotlin DSL 构建、Ktlint + Detekt 作为静态检查。
- CI 计划：`./gradlew lint detekt test`；导入脚本单独跑 `python -m pytest`（预留）。
- 多语言：首版支持中文界面，使用 `strings.xml` 管理文本。

---

## 6. 第 2 阶段迭代 Backlog（核心闭环）
| 优先级 | 工作项 | 说明 |
| --- | --- | --- |
| P0 | 完成多模块 Gradle 项目初始化 | 建立上述模块骨架、配置 Hilt、Room、导航组件 |
| P0 | 实现题目列表读取与单题展示 | 包括资源库 DAO、Compose 卡片、左右分屏容器 |
| P0 | 草稿编辑与自动保存 | Compose 表单、Room 插入、WorkManager 定时任务 |
| P0 | 总结提交与历史回显 | 关联标签、完成次数更新、提示卡片模块 |
| P1 | 标签树浏览与搜索 | Compose Tree 组件、标签数据加载 |
| P1 | 日程创建与提醒触发 | 表单 + WorkManager 调度、日志记录 |
| P1 | Excel/CSV 导入导出 | 基于 `ImportJobProcessor` 完成字段映射与校验 |
| P2 | 单元测试基线 | Repository & UseCase 测试、Compose UI 测试框架搭建 |

---

## 7. 风险评估与质量保障措施

| 风险 | 描述 | 对策 |
| --- | --- | --- |
| 表格字段不统一 | 不同来源题库字段命名混乱 | 提供模板下载、导入校验报告、允许字段映射配置 |
| 数据库性能 | 大体量题库（>5w 条）导致加载缓慢 | 分页加载、预先缓存今日题目、Room 索引关键字段 |
| 标签层级复杂 | 多层标签导致检索效率低 | 在 `tag_nodes` 上建立 `path` 字段与前缀索引，提供搜索缓存 |
| 平板交互适配 | 横屏、多窗口等导致布局错乱 | Compose Constraint/Adaptive Layout，设计分屏 & 手势规范 |
| 数据安全 | 本地数据丢失或导出泄露 | SQLCipher 加密、导出需密码确认、自动备份任务 |

### 7.1 质量基线
- **编码规范**：Ktlint、Detekt 统一风格，Gradle Check 作为 commit 钩子。
- **测试策略**：
  - 单元测试覆盖核心 UseCase（导入解析、推题调度、草稿保存）。
  - UI 测试验证分屏布局、标签搜索、日程表单。
  - 数据一致性脚本：定期校验草稿/总结是否存在孤立记录。
- **文档维护**：数据字典 & API（后续）存放 `docs/`，每次 schema 变更同步更新。

---

## 8. 里程碑回顾与下一步
- ✅ 完成用户目标、流程、信息架构、数据模型、技术栈等第 1 阶段交付内容。
- 📌 待落实事项：启动 Android 工程仓库、实现核心数据表与仓库、草稿/总结 Compose 页面。
- 🎯 下一阶段：依据 Backlog 启动第 2 阶段开发，优先完成刷题闭环功能。

